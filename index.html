<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Cap and Gown Cliff • Survey</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      :root {
        --blue: #006db0;
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-500: #6b7280;
        --gray-600: #4b5563;
        --gray-700: #374151;
        --gray-900: #111827;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        background: var(--gray-50);
        color: var(--gray-900);
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI',
          sans-serif;
        line-height: 1.6;
      }

      a {
        color: inherit;
      }

      header {
        position: sticky;
        top: 0;
        z-index: 10;
        background: #fff;
        border-bottom: 1px solid var(--gray-200);
      }

      .header-inner {
        max-width: 1100px;
        margin: 0 auto;
        padding: 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .brand-mark {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        background: var(--blue);
        display: grid;
        place-items: center;
        color: #fff;
        font-weight: 800;
        font-size: 16px;
      }

      .brand-text {
        display: flex;
        flex-direction: column;
        line-height: 1.1;
      }

      .chip {
        font-size: 12px;
        padding: 6px 10px;
        border-radius: 8px;
        background: var(--gray-100);
        color: var(--gray-500);
      }

      main {
        padding: 32px 16px 64px;
      }

      .section {
        max-width: 900px;
        margin: 0 auto;
        animation: fade-in 0.35s ease;
      }

      .center {
        text-align: center;
      }

      h1 {
        margin: 0 0 12px;
        font-size: clamp(32px, 5vw, 48px);
        font-weight: 800;
      }

      h2 {
        margin: 0 0 12px;
        font-size: clamp(24px, 3vw, 32px);
        font-weight: 700;
      }

      p.lead {
        font-size: 18px;
        color: var(--gray-600);
        margin: 8px 0 24px;
      }

      .badge-line {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: var(--gray-100);
        border-radius: 999px;
        font-weight: 600;
        color: var(--gray-700);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-size: 13px;
      }

      .intro-card {
        background: #fff;
        border: 1px solid var(--gray-200);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.04);
        color: var(--gray-600);
      }

      button.primary {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        border: none;
        cursor: pointer;
        border-radius: 999px;
        background: var(--blue);
        color: #fff;
        padding: 14px 22px;
        font-weight: 800;
        font-size: 16px;
        box-shadow: 0 14px 40px rgba(0, 109, 176, 0.28);
        transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      }

      button.primary:hover {
        transform: translateY(-2px);
        background: #005186;
        box-shadow: 0 18px 46px rgba(0, 109, 176, 0.34);
      }

      button.link {
        border: none;
        background: transparent;
        color: var(--blue);
        cursor: pointer;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .grid {
        display: grid;
        gap: 16px;
      }

      @media (min-width: 768px) {
        .grid.two {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }

      .card {
        background: #fff;
        border: 1px solid var(--gray-200);
        border-radius: 16px;
        padding: 18px;
        transition: border-color 0.15s ease, box-shadow 0.15s ease;
      }

      .card:hover {
        border-color: var(--blue);
        box-shadow: 0 10px 28px rgba(0, 109, 176, 0.12);
      }

      .option {
        display: flex;
        gap: 12px;
        align-items: center;
      }

      .option-icon {
        width: 42px;
        height: 42px;
        border-radius: 12px;
        background: #ecf5fb;
        color: var(--blue);
        display: grid;
        place-items: center;
      }

      .tile {
        display: grid;
        grid-template-columns: 120px 1fr;
        gap: 18px;
        border-radius: 16px;
        border: 1px solid var(--gray-200);
        overflow: hidden;
        background: #fff;
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.04);
      }

      @media (max-width: 640px) {
        .tile {
          grid-template-columns: 1fr;
        }
      }

      .tile-illustration {
        position: relative;
        min-height: 140px;
        display: grid;
        place-items: center;
        padding: 12px;
        border-right: 1px solid var(--gray-200);
      }

      @media (max-width: 640px) {
        .tile-illustration {
          border-right: none;
          border-bottom: 1px solid var(--gray-200);
        }
      }

      .icon-plate {
        width: 62px;
        height: 62px;
        border-radius: 18px;
        background: #fff;
        display: grid;
        place-items: center;
        box-shadow: 0 12px 28px rgba(17, 24, 39, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.7);
      }

      .tile-caption {
        text-transform: uppercase;
        letter-spacing: 0.1em;
        font-weight: 700;
        font-size: 12px;
        color: var(--gray-600);
        margin-top: 10px;
      }

      .tile-body {
        padding: 18px;
      }

      .tile-body label {
        display: block;
        font-weight: 700;
        font-size: 18px;
        color: var(--gray-900);
        margin-bottom: 10px;
      }

      textarea {
        width: 100%;
        min-height: 120px;
        border-radius: 12px;
        border: 1px solid var(--gray-300);
        padding: 14px;
        font-size: 15px;
        font-family: inherit;
        resize: vertical;
        color: var(--gray-700);
        transition: border-color 0.15s ease, box-shadow 0.15s ease;
      }

      textarea:focus {
        outline: none;
        border-color: var(--blue);
        box-shadow: 0 0 0 3px rgba(0, 109, 176, 0.15);
      }

      .actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 12px;
      }

      button.full {
        width: 100%;
        border-radius: 12px;
        padding: 14px;
        font-weight: 800;
        border: none;
        cursor: pointer;
        transition: opacity 0.15s ease, transform 0.15s ease;
      }

      button.full.primary {
        border-radius: 12px;
      }

      button.full:disabled {
        cursor: not-allowed;
        opacity: 0.55;
        transform: none;
        box-shadow: none;
      }

      .note {
        text-align: center;
        color: var(--gray-500);
        font-size: 14px;
      }

      .done-card {
        background: #fff;
        border: 1px solid var(--gray-200);
        border-radius: 18px;
        padding: 24px;
        box-shadow: 0 16px 40px rgba(0, 0, 0, 0.06);
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 12px;
        background: #eef2ff;
        color: #4338ca;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-size: 12px;
      }

      .ai-pane {
        border-left: 4px solid;
        border-radius: 12px;
        padding: 16px;
        background: var(--gray-50);
        color: var(--gray-700);
      }

      .spinner {
        width: 44px;
        height: 44px;
        border: 4px solid #e5e7eb;
        border-top-color: var(--blue);
        border-radius: 999px;
        animation: spin 0.8s linear infinite;
        margin: 16px auto;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      @keyframes fade-in {
        from {
          opacity: 0;
          transform: translateY(6px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-inner">
        <div class="brand">
          <div class="brand-mark">UX</div>
          <div class="brand-text">
            <span style="font-weight: 800;">The Cap and Gown Cliff</span>
            <span style="color: var(--blue); font-weight: 600; font-size: 13px;">Orlando Case Study</span>
          </div>
        </div>
        <div class="chip">Anonymous Mode</div>
      </div>
    </header>

    <main>
      <div id="app" class="section"></div>
    </main>

    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js';
      import { getAuth, onAuthStateChanged, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js';
      import {
        addDoc,
        collection,
        getFirestore,
        serverTimestamp,
      } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js';

      const firebaseConfig = JSON.parse(__firebase_config);
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      const apiKey = '';

      const ILLUSTRATIONS = {
        balance: { icon: 'balance', label: 'Wages vs. rent', accent: '#005b99', backdrop: 'linear-gradient(135deg,#ebf5ff, #ffffff 40%, #dcebff)' },
        diploma_dust: { icon: 'scroll-text', label: 'Degree payoff', accent: '#7c3aed', backdrop: 'linear-gradient(135deg,#f3e8ff, #ffffff 40%, #e9d5ff)' },
        cliff: { icon: 'mountain', label: 'Support cliff', accent: '#e85d04', backdrop: 'linear-gradient(135deg,#fff3e0, #ffffff 40%, #ffe0b2)' },
        breakdown: { icon: 'car', label: 'Unexpected bill', accent: '#b91c1c', backdrop: 'linear-gradient(135deg,#fef2f2, #ffffff 40%, #fee2e2)' },
        house_choice: { icon: 'home', label: 'Housing tradeoff', accent: '#0f766e', backdrop: 'linear-gradient(135deg,#ecfdf3, #ffffff 40%, #d1fae5)' },
        wall: { icon: 'shield', label: 'Institutional barriers', accent: '#334155', backdrop: 'linear-gradient(135deg,#f8fafc, #ffffff 40%, #e2e8f0)' },
        battery: { icon: 'battery-charging', label: 'Energy drain', accent: '#2563eb', backdrop: 'linear-gradient(135deg,#e0ecff, #ffffff 40%, #c7d9ff)' },
        storm: { icon: 'cloud-lightning', label: 'Job market anxiety', accent: '#0ea5e9', backdrop: 'linear-gradient(135deg,#e0f7ff, #ffffff 40%, #bae6fd)' },
        torn_net: { icon: 'shield-off', label: 'No safety net', accent: '#c026d3', backdrop: 'linear-gradient(135deg,#f5e1ff, #ffffff 40%, #e9d5ff)' },
        backpack: { icon: 'backpack', label: 'Family load', accent: '#065f46', backdrop: 'linear-gradient(135deg,#ecfdf3, #ffffff 40%, #d1fae5)' },
        hurdle: { icon: 'fence', label: 'Accommodations blocked', accent: '#ea580c', backdrop: 'linear-gradient(135deg,#fff7ed, #ffffff 40%, #ffead5)' },
        heavy_heart: { icon: 'heart-crack', label: 'Guilt + duty', accent: '#be123c', backdrop: 'linear-gradient(135deg,#fef2f2, #ffffff 40%, #ffe4e6)' },
        couch: { icon: 'sofa', label: 'Shared housing', accent: '#1e40af', backdrop: 'linear-gradient(135deg,#e0ecff, #ffffff 40%, #dbeafe)' },
        piggy_bank: { icon: 'piggy-bank', label: 'Emergency cash', accent: '#15803d', backdrop: 'linear-gradient(135deg,#ecfdf3, #ffffff 40%, #dcfce7)' },
        wand: { icon: 'sparkle', label: 'System change', accent: '#7c3aed', backdrop: 'linear-gradient(135deg,#f3e8ff, #ffffff 40%, #ede9fe)' },
      };

      const PATHS = {
        graduate: {
          title: 'The Graduate',
          icon: 'graduation-cap',
          questions: [
            {
              id: 'paycheck_vs_living',
              text: 'You put in the work to get the degree. How does your current paycheck compare to the cost of living (rent/food) in Orlando?',
              placeholder: 'e.g., I spend 60% of my income on rent...',
              illustration: 'balance',
            },
            {
              id: 'degree_utility',
              text: "Do you feel your degree is helping you right now, or does it feel like a 'sunk cost'? Why?",
              placeholder: "e.g., I'm not even using my major...",
              illustration: 'diploma_dust',
            },
            {
              id: 'support_cliff',
              text: 'When you graduated, did your support system (financial aid, housing, campus resources) cut off before you landed on your feet? What happened?',
              placeholder: 'e.g., My dorm closed and I had nowhere to go...',
              illustration: 'cliff',
            },
          ],
        },
        dropout: {
          title: 'The Non-Completer',
          icon: 'alert-circle',
          questions: [
            {
              id: 'breaking_point',
              text: "Was there a specific moment or bill that made you realize, 'I can't do school right now'?",
              placeholder: 'e.g., My car broke down and I had to choose work...',
              illustration: 'breakdown',
            },
            {
              id: 'trade_off',
              text: 'If you had received free housing or a guaranteed stipend while in school, would you have been able to stay?',
              placeholder: 'e.g., Yes, housing was the main issue...',
              illustration: 'house_choice',
            },
            {
              id: 'system_understanding',
              text: 'Do you feel the university system understands what it’s like to deal with your situation, or did you feel punished?',
              placeholder: "e.g., Professors didn't care that I worked...",
              illustration: 'wall',
            },
          ],
        },
        student: {
          title: 'The Working Student',
          icon: 'book-open',
          questions: [
            {
              id: 'sacrifice',
              text: 'You are working while studying. What is the biggest thing you are sacrificing right now to make that work?',
              placeholder: 'e.g., Sleep, grades, mental health...',
              illustration: 'battery',
            },
            {
              id: 'market_fear',
              text: 'Looking at the job market right now, are you confident that graduating will solve your financial stress?',
              placeholder: "e.g., I'm worried I'll still be broke...",
              illustration: 'storm',
            },
            {
              id: 'safety_net',
              text: 'If you lost your job tomorrow, would you be able to stay in school? Who would you call for help?',
              placeholder: "e.g., I'd have to drop out...",
              illustration: 'torn_net',
            },
          ],
        },
        caretaker: {
          title: 'The Caretaker / Barrier',
          icon: 'hand-heart',
          questions: [
            {
              id: 'bandwidth',
              text: "How much of your 'bandwidth' (money or time) goes to helping your family instead of focusing on your own career?",
              placeholder: "e.g., I pay my mom's rent...",
              illustration: 'backpack',
            },
            {
              id: 'hidden_barrier',
              text: "Has a job or school ever rejected you or made things harder because they didn't want to accommodate your needs?",
              placeholder: "e.g., I couldn't make the schedule work...",
              illustration: 'hurdle',
            },
            {
              id: 'guilt',
              text: 'Do you feel guilty focusing on your own education when your family is struggling?',
              placeholder: 'e.g., I feel selfish sometimes...',
              illustration: 'heavy_heart',
            },
          ],
        },
      };

      const UNIVERSAL_QUESTIONS = [
        {
          id: 'housing_security',
          text: "Do you currently have a lease in your own name, or are you 'doubling up' / staying with others to make rent?",
          placeholder: "e.g., Sleeping on a friend's couch...",
          illustration: 'couch',
        },
        {
          id: 'emergency_gap',
          text: 'If you had an emergency expense of $500 today, how would you pay for it?',
          placeholder: "e.g., Credit card, or I couldn't...",
          illustration: 'piggy_bank',
        },
        {
          id: 'magic_wand',
          text: 'If the system could change one thing to help people like us—not a scholarship, but actual life support—what would it be?',
          placeholder: 'e.g., Guaranteed housing for 6 months post-grad...',
          illustration: 'wand',
        },
      ];

      const state = {
        step: 'intro',
        selectedPath: null,
        answers: {},
        user: null,
        aiNarrative: null,
        aiAnalysis: null,
        isGenerating: false,
      };

      const appRoot = document.getElementById('app');

      const signIn = async () => {
        try {
          if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInAnonymously(auth);
          } else {
            await signInAnonymously(auth);
          }
        } catch (e) {
          console.error('Auth failed', e);
        }
      };

      onAuthStateChanged(auth, (user) => {
        state.user = user;
      });
      signIn();

      function tileHtml(meta) {
        return `
          <div class="tile-illustration" style="background:${meta.backdrop}">
            <div class="icon-plate" aria-hidden>
              <i data-lucide="${meta.icon}" style="width:26px;height:26px;color:${meta.accent}"></i>
            </div>
            <div class="tile-caption">${meta.label}</div>
          </div>
        `;
      }

      function questionCard(q) {
        const meta = ILLUSTRATIONS[q.illustration];
        const value = state.answers[q.id] || '';
        return `
          <div class="tile">
            ${tileHtml(meta)}
            <div class="tile-body">
              <label for="${q.id}">${q.text}</label>
              <textarea id="${q.id}" name="${q.id}" placeholder="${q.placeholder}">${value}</textarea>
            </div>
          </div>
        `;
      }

      function renderIntro() {
        appRoot.innerHTML = `
          <div class="center">
            <div style="width:96px;height:96px;border-radius:999px;background:#e5f2fb;border:1px solid #d5e7f5;display:grid;place-items:center;margin:0 auto 12px;">
              <i data-lucide="map-pin" style="width:46px;height:46px;color:var(--blue);"></i>
            </div>
            <h1>The Cap and Gown Cliff</h1>
            <div class="badge-line"><span style="width:10px;height:10px;border-radius:999px;background:var(--blue);"></span> Orlando Case Study</div>
            <h2 style="color: var(--gray-700); margin-top: 12px;">Defining the Structural Failure Leading from Higher Education to Homelessness.</h2>
            <div class="intro-card">
              For many, graduation marks not a beginning, but a precipice. We are documenting the <strong>"Support Cliff"</strong> in Central Florida—where rising rents, low wages, and the sudden loss of university support create a direct path to housing instability.
              <br /><br />
              This is not about individual failure. It is about a <strong>structural breakdown</strong>. We need your story to prove it.
            </div>
            <div style="margin-top: 22px;">
              <button class="primary" id="start-btn">Share Your Experience <i data-lucide="chevron-right" style="width:18px;height:18px;"></i></button>
              <div style="margin-top:8px;color:var(--gray-400);font-size:12px;letter-spacing:0.12em;text-transform:uppercase;">Anonymous • Research Data Only</div>
            </div>
          </div>
        `;
        bindIntro();
        lucide.createIcons();
      }

      function bindIntro() {
        document.getElementById('start-btn')?.addEventListener('click', () => {
          state.step = 'screener';
          render();
        });
      }

      function renderScreener() {
        const options = [
          { id: 'graduate', title: 'The Graduate', desc: "I have the degree, but I'm facing the 'cliff' of underemployment or housing instability.", icon: 'graduation-cap' },
          { id: 'dropout', title: 'The Non-Completer', desc: 'I had to pause/stop college to focus on work, survival, or health.', icon: 'alert-circle' },
          { id: 'student', title: 'The Overworked Student', desc: "I'm currently in school, but I work nearly full-time to survive Orlando's costs.", icon: 'book-open' },
          { id: 'caretaker', title: 'The Caretaker / Barrier', desc: 'My family obligations or systemic barriers define my educational journey.', icon: 'hand-heart' },
        ];

        appRoot.innerHTML = `
          <div>
            <button class="link" id="back-intro"><i data-lucide="arrow-left" style="width:16px;height:16px;"></i> Back</button>
            <h2 class="center" style="margin-top:8px;">Which path best describes your reality?</h2>
            <div class="grid two" style="margin-top:18px;">
              ${options
                .map(
                  (o) => `
                    <button class="card option" data-path="${o.id}" style="text-align:left;">
                      <div class="option-icon"><i data-lucide="${o.icon}" style="width:22px;height:22px;"></i></div>
                      <div>
                        <div style="font-weight:800;color:var(--gray-900);">${o.title}</div>
                        <div style="color:var(--gray-600);font-size:14px;">${o.desc}</div>
                      </div>
                    </button>`
                )
                .join('')}
            </div>
          </div>
        `;
        bindScreener();
        lucide.createIcons();
      }

      function bindScreener() {
        document.getElementById('back-intro')?.addEventListener('click', () => {
          state.step = 'intro';
          render();
        });

        document.querySelectorAll('[data-path]')?.forEach((btn) => {
          btn.addEventListener('click', () => {
            const path = btn.getAttribute('data-path');
            state.selectedPath = path;
            state.step = 'questions';
            window.scrollTo(0, 0);
            render();
          });
        });
      }

      function renderQuestions() {
        if (!state.selectedPath) return renderScreener();
        const path = PATHS[state.selectedPath];

        const cards = path.questions.map((q) => questionCard(q)).join('');
        appRoot.innerHTML = `
          <div>
            <div style="display:flex;align-items:center;gap:8px;color:var(--gray-500);font-size:14px;">
              <button class="link" id="back-screener"><i data-lucide="arrow-left" style="width:16px;height:16px;"></i> Back</button>
              <span>/</span>
              <span style="color:var(--blue);font-weight:700;">${path.title}</span>
            </div>
            <div style="margin:18px 0 14px;">
              <h2>Mapping Your Journey</h2>
              <p class="lead">Be specific. Your details help define the system failure.</p>
            </div>
            <div class="grid" style="gap:18px;">${cards}</div>
            <div class="actions">
              <button class="full primary" id="next-universal">Next Section</button>
              ${path.questions.some((q) => !state.answers[q.id]) ? '<div class="note">Please fill out all fields to continue</div>' : ''}
            </div>
          </div>
        `;
        bindQuestions(path);
        lucide.createIcons();
      }

      function bindQuestions(path) {
        path.questions.forEach((q) => {
          document.getElementById(q.id)?.addEventListener('input', (e) => {
            state.answers[q.id] = e.target.value;
          });
        });

        document.getElementById('back-screener')?.addEventListener('click', () => {
          state.step = 'screener';
          render();
        });

        const btn = document.getElementById('next-universal');
        if (btn) {
          btn.disabled = path.questions.some((q) => !state.answers[q.id]);
          btn.addEventListener('click', () => {
            if (btn.disabled) return;
            state.step = 'universal';
            window.scrollTo(0, 0);
            render();
          });
        }
      }

      function renderUniversal() {
        const cards = UNIVERSAL_QUESTIONS.map((q) => questionCard(q)).join('');
        appRoot.innerHTML = `
          <div>
            <div style="display:flex;align-items:center;gap:8px;color:var(--gray-500);font-size:14px;">
              <button class="link" id="back-questions"><i data-lucide="arrow-left" style="width:16px;height:16px;"></i> Back</button>
              <span>/</span>
              <span style="color:var(--blue);font-weight:700;">Systemic Impact</span>
            </div>
            <div style="margin:18px 0 14px;">
              <h2>The Structural Gap</h2>
              <p class="lead">These final questions identify where the safety net broke.</p>
            </div>
            <div class="grid" style="gap:18px;">${cards}</div>
            <div class="actions">
              <button class="full primary" id="submit-final">Submit Response <i data-lucide="send" style="width:18px;height:18px;"></i></button>
            </div>
          </div>
        `;
        bindUniversal();
        lucide.createIcons();
      }

      function bindUniversal() {
        UNIVERSAL_QUESTIONS.forEach((q) => {
          document.getElementById(q.id)?.addEventListener('input', (e) => {
            state.answers[q.id] = e.target.value;
          });
        });

        document.getElementById('back-questions')?.addEventListener('click', () => {
          state.step = 'questions';
          render();
        });

        document.getElementById('submit-final')?.addEventListener('click', submitFinal);
      }

      async function submitFinal() {
        if (!state.user || !state.selectedPath) return;
        state.step = 'submitting';
        render();

        try {
          const payload = {
            userId: state.user.uid,
            path: state.selectedPath,
            responses: state.answers,
            timestamp: serverTimestamp(),
            appId: appId,
          };

          await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'survey_responses'), payload);
          state.step = 'done';
        } catch (error) {
          console.error('Error submitting survey:', error);
          alert('There was an error submitting your responses. Please try again.');
          state.step = 'universal';
        }
        render();
      }

      async function callGemini(prompt) {
        try {
          const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
            },
          );

          if (!response.ok) throw new Error(response.statusText);
          const data = await response.json();
          return data.candidates?.[0]?.content?.parts?.[0]?.text || 'Unable to generate analysis at this time.';
        } catch (error) {
          console.error('Gemini API Error:', error);
          return 'Service temporarily unavailable. Please try again later.';
        }
      }

      async function generateNarrative() {
        state.isGenerating = true;
        render();
        const userStory = Object.entries(state.answers)
          .map(([key, value]) => `${key}: ${value}`)
          .join('\n');
        const prompt = `
      Role: Empathetic UX Researcher / Journalist.
      Task: Synthesize the following survey responses from a student in Orlando into a powerful, anonymous first-person testimonial (approx 3-4 sentences).
      Context: The "Cap and Gown Cliff" - the systemic failure of higher ed support systems.
      Goal: Make the user feel heard and validate that their struggle is systemic, not personal.
      User Data:
      ${userStory}

      Output: A quoted testimonial.
    `;
        const result = await callGemini(prompt);
        state.aiNarrative = result;
        state.isGenerating = false;
        render();
      }

      async function generateSystemicCheck() {
        state.isGenerating = true;
        render();
        const userStory = Object.entries(state.answers)
          .map(([key, value]) => `${key}: ${value}`)
          .join('\n');
        const prompt = `
      Role: Social Scientist / Data Analyst.
      Task: Analyze this user's specific situation against the context of the Orlando Housing Crisis and the "Student Support Cliff".
      Goal: Provide 2-3 specific insights that validate their experience with systemic context (e.g., mention rising rents, lack of safety nets).
      Tone: Professional, validating, educational.
      User Data:
      ${userStory}
    `;
        const result = await callGemini(prompt);
        state.aiAnalysis = result;
        state.isGenerating = false;
        render();
      }

      function renderSubmitting() {
        appRoot.innerHTML = `
          <div class="center">
            <div class="spinner"></div>
            <p style="color:var(--gray-500);">Saving anonymous data...</p>
          </div>
        `;
      }

      function renderDone() {
        appRoot.innerHTML = `
          <div class="center" style="max-width:720px;margin:0 auto;">
            <div style="width:72px;height:72px;border-radius:999px;background:#dcfce7;display:grid;place-items:center;margin:0 auto 12px;">
              <i data-lucide="check-circle" style="width:36px;height:36px;color:#15803d;"></i>
            </div>
            <h2>Response Recorded.</h2>
            <p class="lead">Your data has been added to the study. Thank you for helping us make the invisible visible.</p>
            <div class="done-card" style="text-align:left;">
              <div class="pill"><i data-lucide="sparkles" style="width:16px;height:16px;"></i> Powered by Gemini AI</div>
              <h3 style="margin:16px 0 8px;">Analyze Your Impact</h3>
              <p style="color:var(--gray-600);font-size:14px;">Use AI to instantly see how your personal story connects to the broader structural failure in Orlando.</p>
              <div class="grid two" style="margin:16px 0;gap:12px;">
                <button class="card option" id="btn-narrative" style="text-align:left;">
                  <div class="option-icon" style="background:#eef2ff;color:#4338ca;"><i data-lucide="book-open" style="width:18px;height:18px;"></i></div>
                  <div>
                    <div style="font-weight:800;color:#312e81;">The Narrative Mirror</div>
                    <div style="color:#4338ca;font-size:13px;">Synthesize my answers into a cohesive, anonymous user story.</div>
                  </div>
                </button>
                <button class="card option" id="btn-systemic" style="text-align:left;">
                  <div class="option-icon" style="background:#f3e8ff;color:#7c3aed;"><i data-lucide="brain" style="width:18px;height:18px;"></i></div>
                  <div>
                    <div style="font-weight:800;color:#6b21a8;">Systemic Reality Check</div>
                    <div style="color:#7c3aed;font-size:13px;">Validate my struggle against Orlando economic data.</div>
                  </div>
                </button>
              </div>
              ${state.isGenerating ? '<div class="center" style="color:var(--gray-500);"><div class="spinner"></div><div>Generating insight...</div></div>' : ''}
              ${state.aiNarrative && !state.isGenerating ? `<div class="ai-pane" style="border-color:#6366f1;">
                <strong style="color:#3730a3;text-transform:uppercase;letter-spacing:0.08em;font-size:12px;">Your Anonymous Narrative</strong>
                <p style="font-style:italic;">"${state.aiNarrative}"</p>
              </div>` : ''}
              ${state.aiAnalysis && !state.isGenerating ? `<div class="ai-pane" style="border-color:#a855f7;">
                <strong style="color:#7e22ce;text-transform:uppercase;letter-spacing:0.08em;font-size:12px;">Systemic Analysis</strong>
                <div style="white-space:pre-wrap;">${state.aiAnalysis}</div>
              </div>` : ''}
            </div>
            <button class="link" id="restart"><i data-lucide="refresh-cw" style="width:16px;height:16px;"></i> Start a new response</button>
          </div>
        `;
        bindDone();
        lucide.createIcons();
      }

      function bindDone() {
        document.getElementById('btn-narrative')?.addEventListener('click', () => {
          if (state.isGenerating) return;
          generateNarrative();
        });
        document.getElementById('btn-systemic')?.addEventListener('click', () => {
          if (state.isGenerating) return;
          generateSystemicCheck();
        });
        document.getElementById('restart')?.addEventListener('click', () => window.location.reload());
      }

      function render() {
        switch (state.step) {
          case 'intro':
            renderIntro();
            break;
          case 'screener':
            renderScreener();
            break;
          case 'questions':
            renderQuestions();
            break;
          case 'universal':
            renderUniversal();
            break;
          case 'submitting':
            renderSubmitting();
            break;
          case 'done':
            renderDone();
            break;
          default:
            renderIntro();
        }
      }

      render();
    </script>
  </body>
</html>
